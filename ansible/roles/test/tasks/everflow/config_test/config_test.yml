- name: Define variables for test
  set_fact:
    testname: config_test
    config_files:
        - config_src_ip_invalid_1.json
        - config_dst_ip_invalid_1.json
        - config_gre_type_invalid_1.json
        - config_gre_type_invalid_2.json
        - config_gre_type_invalid_3.json
        - config_dscp_invalid_1.json
        - config_dscp_invalid_2.json
        - config_dscp_invalid_3.json
        - config_ttl_invalid_1.json
        - config_ttl_invalid_2.json
        - config_ttl_invalid_3.json
        - config_queue_invalid_1.json
        - config_queue_invalid_2.json
        - config_queue_invalid_3.json
        - config_valid_1.json
        - config_valid_2.json
        - config_delete.json

- name: Copy JSON configs onto switch.
  copy: src={{ tests_location }}/{{ testname }}/{{ item }} dest={{ run_dir }}/{{ item }}
  with_items:
      - "{{ config_files }}"

- name: Copy JSON configs from switch into docker filesystem.
  command: docker cp {{ run_dir }}/{{ item }} swss:{{ docker_testdir }}/{{ item }}
  with_items:
      - "{{ config_files }}"

- block:
    - name: Config tests - invalid SRC IP address.
      vars:
        config_file: config_src_ip_invalid_1.json
        test_expect_file: config_test_expect_file
        errors_expected: true
        run_cleanup: true
      include: roles/test/tasks/run_config_test.yml

    - name: Config tests - invalid DST IP address.
      vars:
        config_file: config_dst_ip_invalid_1.json
        test_expect_file: config_test_expect_file
        errors_expected: true
        run_cleanup: true
      include: roles/test/tasks/run_config_test.yml

    - name: Config tests - invalid GRE type (non integer value).
      vars:
        config_file: config_gre_type_invalid_1.json
        test_expect_file: config_test_expect_file
        errors_expected: true
        run_cleanup: true
      include: roles/test/tasks/run_config_test.yml

    - name: Config tests - invalid GRE type (value < that min bound).
      vars:
        config_file: config_gre_type_invalid_2.json
        test_expect_file: config_test_expect_file
        errors_expected: true
        run_cleanup: true
      include: roles/test/tasks/run_config_test.yml

    - name: Config tests - invalid GRE type (value > that min bound).
      vars:
        config_file: config_gre_type_invalid_3.json
        test_expect_file: config_test_expect_file
        errors_expected: true
        run_cleanup: true
      include: roles/test/tasks/run_config_test.yml

    - name: Config tests - invalid DSCP (non integer value).
      vars:
        config_file: config_dscp_invalid_1.json
        test_expect_file: config_test_expect_file
        errors_expected: true
        run_cleanup: true
      include: roles/test/tasks/run_config_test.yml

    - name: Config tests - invalid DSCP (value < that min bound).
      vars:
        config_file: config_dscp_invalid_2.json 
        test_expect_file: config_test_expect_file
        errors_expected: true
        run_cleanup: true
      include: roles/test/tasks/run_config_test.yml

    - name: Config tests - invalid DSCP (value > that min bound).
      vars:
        config_file: config_dscp_invalid_3.json
        test_expect_file: config_test_expect_file
        errors_expected: true
        run_cleanup: true
      include: roles/test/tasks/run_config_test.yml

    - name: Config tests - invalid TTL (non integer value).
      vars:
        config_file:  config_ttl_invalid_1.json
        test_expect_file: config_test_expect_file
        errors_expected: true
        run_cleanup: true
      include: roles/test/tasks/run_config_test.yml

    - name: Config tests - invalid TTL (value < that min bound).
      vars:
        config_file: config_ttl_invalid_2.json
        test_expect_file: config_test_expect_file
        errors_expected: true
        run_cleanup: true
      include: roles/test/tasks/run_config_test.yml

    - name: Config tests - invalid TTL (value > that min bound).
      vars:
        config_file: config_ttl_invalid_3.json
        test_expect_file: config_test_expect_file
        errors_expected: true
        run_cleanup: true
      include: roles/test/tasks/run_config_test.yml

    - name: Config tests - invalid queue (non integer value).
      vars:
        config_file: config_queue_invalid_1.json
        test_expect_file: config_test_expect_file
        errors_expected: true
        run_cleanup: true
      include: roles/test/tasks/run_config_test.yml

    - name: Config tests - invalid queue (value < that min bound).
      vars:
        config_file: config_queue_invalid_2.json
        test_expect_file: config_test_expect_file
        errors_expected: true
        run_cleanup: true
      include: roles/test/tasks/run_config_test.yml

    - name: Config tests - invalid queue (value > that max bound).
      vars:
        config_file: config_queue_invalid_3.json 
        test_expect_file: config_test_expect_file
        errors_expected: true
        run_cleanup: true
      include: roles/test/tasks/run_config_test.yml

    - name: Config tests - valid config (all integers are in 10 base).
      vars:
        config_file: config_valid_1.json
        test_expect_file: config_test_expect_file
        errors_expected: false
        run_cleanup: true
      include: roles/test/tasks/run_config_test.yml

    - name: Config tests - valid config (all integers are in hex).
      vars:
        config_file: config_valid_2.json
        test_expect_file: config_test_expect_file
        errors_expected: false
        run_cleanup: true
      include: roles/test/tasks/run_config_test.yml

    - name: Config tests - delete configuration part 1 (apply config).
      vars:
        config_file: config_valid_2.json
        test_expect_file: config_test_expect_file
        errors_expected: false
        run_cleanup: false
      include: roles/test/tasks/run_config_test.yml

    - name: Config tests - delete configuration part 2 (delete config).
      vars:
        config_file: config_delete.json
        test_expect_file: config_test_expect_file
        errors_expected: false
        run_cleanup: true
      include: roles/test/tasks/run_config_test.yml

  always:
    - name: Remove all the temporary files created by the test.
      file: path="{{ run_dir }}/{{ item }}" state=absent
      with_items:
          - "{{ config_files }}"

